<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <title>Welcome to St David's</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
    crossorigin="anonymous"></script>

  <div class="container text-center">
    <br>
    <h1>Welcome to St David's</h1>

    <div id="signInForm">
      <div class="container" style="padding-top: 30vh;" id="startButtons">
        <div style="padding: 0.3vw;">
          <button class="btn btn-secondary btn-lg" type="button" data-bs-toggle="collapse" data-bs-target="#regular"
            aria-expanded="false" aria-controls="regular">
            I'm A Regular
          </button>
        </div>
        <div style="padding: 0.3vw;">
          <button class="btn btn-primary btn-lg" type="button" data-bs-toggle="collapse" data-bs-target="#newMember"
            aria-expanded="false" aria-controls="newMember">
            I'm New Here
          </button>
        </div>
      </div>

      <div class="collapse" id="regular">
        <form id="regularForm">
          <div class="mb-3">
            <input type="text" class="form-control" placeholder="First Name" id="regularFirstName" required>
          </div>
          <div class="mb-3">
            <input type="text" class="form-control" placeholder="Last Name" id="regularLastName" required>
          </div>
          <!-- <div class="mb-3">
            <input type="text" class="form-control" id="nameInput" autocomplete="off"
              placeholder="Please enter your full name" data-bs-toggle="dropdown" required>
            <div>
              <ul class="dropdown-menu overflow-scroll" id="dropdownNamesMenu" style="max-height: 60vh;"></ul>
            </div>
          </div> -->
          <div id="alertSignIn"></div>
          <div id="regularNameStatus"></div>
          <br>
          <div>
            <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#regular"
              aria-expanded="false" aria-controls="regular">Back</button>
            <button type="submit" class="btn btn-primary" id="submitRegular" disabled>Print A Name Tag</button>
          </div>
        </form>
      </div>

      <div class="collapse" id="newMember">
        <form id="newMemberForm">
          <div class="mb-3">
            <input type="text" class="form-control" placeholder="First Name" id="newFirstName" required>
          </div>
          <div class="mb-3">
            <input type="text" class="form-control" placeholder="Last Name" id="newLastName" required>
          </div>
          <div class="mb-3">
            <input type="text" class="form-control" placeholder="Phone Number or Email" id="contact" required
              pattern="^([a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3})|(\d{3}-\d{3}-\d{4})$">
          </div>
          <div id="alertNewSignIn"></div>
          <div>
            <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#newMember"
              aria-expanded="false" aria-controls="newMember">Back</button>
            <button type="submit" class="btn btn-primary">Print A Name Tag</button>
          </div>
        </form>
      </div>

    </div>
  </div>

  <script>
    regular.addEventListener('show.bs.collapse', event => startButtons.hidden = true);
    regular.addEventListener('hidden.bs.collapse', event => startButtons.hidden = false);
    newMember.addEventListener('show.bs.collapse', event => startButtons.hidden = true);
    newMember.addEventListener('hidden.bs.collapse', event => startButtons.hidden = false);
  </script>

  <script>
    let globalFirstname = '';
    let globalLastname = '';
    let globalId = '';

    (async () => {
      let names = await fetch('/people')
        .then(response => response.json())
        .then(result => result.people.map(name => {
          return { ...name, fullname: name.firstname + ' ' + name.lastname }
        }))
        .catch(err => {
          alertSignIn.innerHTML = `
              <div class="alert alert-danger" role="alert">
                  Something went wrong, please try again later.
              </div>`;
        });
      console.log(names)

      const regularFirstNameElement = document.getElementById('regularFirstName');
      const regularLastNameElement = document.getElementById('regularLastName');
      const regularNameStatusElement = document.getElementById('regularNameStatus')

      regularFirstNameElement.addEventListener('input', getRegularFirstName);
      regularLastNameElement.addEventListener('input', getRegularLastName);

      function getRegularFirstName(e) {
        globalFirstname = e.target.value;
        isRegularNameInDatabase(globalFirstname, globalLastname);
      }

      function getRegularLastName(e) {
        globalLastname = e.target.value;
        isRegularNameInDatabase(globalFirstname, globalLastname);
      }

      function isRegularNameInDatabase(regularFirstname, regularLastname) {
        let regularFullname = (regularFirstname + ' ' + regularLastname).toLowerCase();
        let name = names.find(name => name.fullname.toLowerCase() === regularFullname);
        if (name !== undefined) {
          globalId = name.id;
          regularNameStatusElement.textContent = regularFirstname + ' ' + regularLastname + ' was found in the church database';
          submitRegular.disabled = false;
        } else {
          regularNameStatusElement.textContent = '';
          submitRegular.disabled = true;
        }
      }

      // nameInput.addEventListener('input', event => {
      //   document.getElementById('dropdownNamesMenu').innerHTML = names
      //     .filter(name => name.fullname.toLowerCase().includes(nameInput.value.toLowerCase()))
      //     .map(name => `<li><a class="dropdown-item" href="#" onclick="clickName('${name.firstname}', '${name.lastname}', '${name.fullname}')">${name.fullname}</a></li>`)
      //     .join(' ');

      //   const dropdownElementList = document.querySelectorAll('.dropdown-toggle')
      //   const dropdownList = [...dropdownElementList].map(dropdownToggleEl => new bootstrap.Dropdown(dropdownToggleEl))
      // let name = names.find(name => name.fullname === nameInput.value)
      // if (name !== undefined) {
      //   autocomplete(name.firstname, name.lastname);
      // } else {
      //   submitRegular.disabled = true;
      // }

      // });
    })();

    // function autocomplete(firstname, lastname) {
    //   submitRegular.disabled = false;
    //   globalFirstname = firstname;
    //   globalLastname = lastname;
    // }

    // function clickName(firstname, lastname, fullname) {
    //   autocomplete(firstname, lastname);
    //   nameInput.value = fullname;
    // }

    postInfo = async (endPoint, payload) => {
      await fetch(endPoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
        .then(response => response.json())
        .then(() => signInForm.innerHTML = `<p style="padding-top: 30vh;">Thanks ${payload.firstname} for signing in!</p>
          <p>Have you signed in the rest of your family?</p>
          <a href=""><button type="submit" class="btn btn-primary">Sign In Others</button></a>  
            
          `)
        .catch((err) => {
          alertSignIn.innerHTML = `
            <div class="alert alert-danger" role="alert">
                Sorry, it looks like you have already signed in.
            </div>`;
          alertNewSignIn.innerHTML = `
            <div class="alert alert-danger" role="alert">
                An error occurred, please try again later.
            </div>`;
        });
    }

    regularForm.onsubmit = async (e) => {
      e.preventDefault();
      await postInfo('/member/regular', { id: globalId });
    };
    newMemberForm.onsubmit = async (e) => {
      e.preventDefault();
      await postInfo('/member/new', { firstname: newFirstName.value, lastname: newLastName.value, contact: contact.value });
    };
  </script>
</body>

</html>