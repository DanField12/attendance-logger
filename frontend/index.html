<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <title>Welcome to St David's</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
    crossorigin="anonymous"></script>

  <div class="container text-center">
    <br>
    <h1>Welcome to St David's</h1>
    <br>
    <div id="signInForm">
      <div class="container" style="padding-top: 30vh;" id="startButtons">
        <div style="padding: 0.3vw;">
          <button class="btn btn-secondary btn-lg" type="button" data-bs-toggle="collapse"
            data-bs-target="#regularMember" aria-expanded="false" aria-controls="regularMember">
            I'm A Regular
          </button>
        </div>
        <div style="padding: 0.3vw;">
          <button class="btn btn-primary btn-lg" type="button" data-bs-toggle="collapse" data-bs-target="#newMember"
            aria-expanded="false" aria-controls="newMember">
            I'm New Here
          </button>
        </div>
      </div>

      <div class="collapse" id="regularMember">
        <form id="regularForm">
          <div class="mb-3">
            <input type="text" class="form-control" placeholder="First Name" id="regularMemberFirstName" required>
          </div>
          <div class="mb-3">
            <input type="text" class="form-control" placeholder="Last Name" id="regularMemberLastName" required>
          </div>
          <div id="alertSignIn"></div>
          <div id="regularMemberNameStatus"></div>
          <div id="regularMemberFamilyPrompt"></div>
          <div id="regularMemberFamilyCheckboxes"></div>
          <br>
          <div>
            <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#regularMember"
              aria-expanded="false" aria-controls="regularMember">Back</button>
            <button type="submit" class="btn btn-primary" id="submitRegular" disabled>Print A Name Tag</button>
          </div>
        </form>
      </div>

      <div class="collapse" id="newMember">
        <form id="newMemberForm">
          <div class="mb-3">
            <input type="text" class="form-control" placeholder="First Name" id="newFirstName" required>
          </div>
          <div class="mb-3">
            <input type="text" class="form-control" placeholder="Last Name" id="newLastName" required>
          </div>
          <div class="mb-3">
            <input type="text" class="form-control" placeholder="Phone Number or Email" id="contact" required
              pattern="^([a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3})|(\d{3}-\d{3}-\d{4})$">
          </div>
          <div id="alertNewSignIn"></div>
          <div>
            <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#newMember"
              aria-expanded="false" aria-controls="newMember">Back</button>
            <button type="submit" class="btn btn-primary">Print A Name Tag</button>
          </div>
        </form>
      </div>

    </div>
  </div>

  <script>
    regularMember.addEventListener('show.bs.collapse', event => startButtons.hidden = true);
    regularMember.addEventListener('hidden.bs.collapse', event => startButtons.hidden = false);
    newMember.addEventListener('show.bs.collapse', event => startButtons.hidden = true);
    newMember.addEventListener('hidden.bs.collapse', event => startButtons.hidden = false);
  </script>

  <script>
    let globalFirstname = '';
    let globalLastname = '';
    let globalId = '';
    let globalFamilyMemberIds = [];

    (async () => {
      let names = await fetch('/people')
        .then(response => response.json())
        .then(result => result.people.map(name => {
          return { ...name, fullname: name.firstname + ' ' + name.lastname }
        }))
        .catch(err => {
          alertSignIn.innerHTML = `
              <div class="alert alert-danger" role="alert">
                  Could not fetch church members! Please try again later.
              </div>`;
        });
      // console.log(names)

      async function fetchFamilyMembers(personID) {
        try {
          const response = await fetch('/familyMembers?' + new URLSearchParams({
            id: personID
          }));
          if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
          }
          const data = await response.json();
          return data;
        }
        catch (error) {
          console.error(`Could not fetch family members: ${error}`);
        }
      }

      const regularMemberFirstNameElement = document.getElementById('regularMemberFirstName');
      const regularMemberLastNameElement = document.getElementById('regularMemberLastName');

      regularMemberFirstNameElement.addEventListener('input', getRegularMemberFirstName);
      regularMemberLastNameElement.addEventListener('input', getRegularMemberLastName);

      function getRegularMemberFirstName(e) {
        globalFirstname = e.target.value;
        isRegularMemberInDatabase(globalFirstname, globalLastname);
      }

      function getRegularMemberLastName(e) {
        globalLastname = e.target.value;
        isRegularMemberInDatabase(globalFirstname, globalLastname);
      }

      function isRegularMemberInDatabase(firstname, lastname) {
        let fullname = (firstname + ' ' + lastname).toLowerCase();
        let name = names.find(name => name.fullname.toLowerCase() === fullname);
        if (name !== undefined) {
          globalId = name.id;
          regularMemberNameStatus.innerHTML = `<br>
            <div class="alert alert-secondary" role="alert">
              ${firstname.charAt(0).toUpperCase() + firstname.slice(1)} ${lastname.charAt(0).toUpperCase() + lastname.slice(1)} was found in the church database.
            </div>`

          submitRegular.disabled = false;

          const promiseFamilyMembers = fetchFamilyMembers(globalId);
          promiseFamilyMembers.then(
            (data) => {
              if (data.family.length > 0) {
                regularMemberFamilyPrompt.innerHTML = `<div class="alert alert-primary" role="alert">Please check-in any family members that are also attending:</div>`;

                var buildFamilyMembersCheckboxes = `<div class="form-check form-check-inline">`;
                for (f in data.family) {
                  buildFamilyMembersCheckboxes = buildFamilyMembersCheckboxes +
                    `<input class="form-check-input" type="checkbox" value="" id=${data.family[f].id}>
                    <label class="form-check-label" for="flexCheckDefault">
                      ${data.family[f].firstname} ${data.family[f].lastname}
                    </label><br>`
                }
                regularMemberFamilyCheckboxes.innerHTML = buildFamilyMembersCheckboxes + `</div><br><br>`;
              }
            }
          );
        } else {
          regularMemberNameStatus.innerHTML = ``;
          regularMemberFamilyPrompt.innerHTML = ``;
          regularMemberFamilyCheckboxes.innerHTML = ``;
          submitRegular.disabled = true;
        }
      }
    })();

    postInfo = async (endPoint, payload) => {
      // Get family members (if any)
      var checkedFamilyMembers = document.querySelectorAll('input[type="checkbox"]:checked');
      for (var checkedFamilyMember of checkedFamilyMembers) {
        globalFamilyMemberIds.push(checkedFamilyMember.id);
      }
      console.log(globalFamilyMemberIds);
      console.log(JSON.stringify(payload));

      await fetch(endPoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
        .then(response => response.json())
        .then(() => signInForm.innerHTML = `<p style="padding-top: 30vh;">Successful sign-in of ${globalFamilyMemberIds.length + 1} member(s).</p>
          <p>Have you signed in the rest of your family?</p>
          <a href=""><button type="submit" class="btn btn-primary">Sign In Others</button></a>`
          )
        .catch((err) => {
          alertSignIn.innerHTML = `
            <div class="alert alert-danger" role="alert">
                You are already signed in!
            </div>`;
        });
    }

    regularForm.onsubmit = async (e) => {
      e.preventDefault();
      await postInfo('/member/regulars', { id: globalId, familyIds: globalFamilyMemberIds });
    };
    newMemberForm.onsubmit = async (e) => {
      e.preventDefault();
      await postInfo('/member/new', { firstname: newFirstName.value, lastname: newLastName.value, contact: contact.value });
    };
  </script>
</body>

</html>